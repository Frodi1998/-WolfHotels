Date.prototype.addDays=function(days){var date=new Date(this.valueOf());date.setDate(date.getDate()+days);return date;}
var $=jQuery;var g={lastSelectedDate:'',maxDate:'',firstDayClassApplied:false,january_dates:[1,2,4,5,6,7]};var apiData=[];$(document).ready(function(){getCalendarParameters();$(".datepicker-from").attr("readonly","readonly");$(".datepicker-to").attr("readonly","readonly");$(".datepicker-to").attr("disabled","disabled");var inputIds=$("input").map(function(){return this.id;}).get().join(" ");$(function(){$(".datepicker-from").datepicker({minDate:0,numberOfMonths:2,yearRange:"-2:+2",onChangeMonthYear:function(year,month,inst){let that=this;setTimeout(function(){add_datepicker_footer();},150);},beforeShow:function(input,inst){let that=this;$("#ui-datepicker-div").removeClass(inputIds);$("#ui-datepicker-div").addClass(this.id);setTimeout(function(){add_datepicker_footer();},150);return[true,""];},beforeShowDay:function(date){let validation=beforeShowDayValidation(date,'from');return[validation.validate,validation.cssClassName];},onSelect:function(dateText,inst){var dateFrom=$(this).datepicker("getDate");let $form=$(this).closest("form");let $datepickerFrom=$form.find(".datepicker-from");let $datepickerTo=$form.find(".datepicker-to");$datepickerTo.removeAttr("disabled");onSelectEventFrom(dateFrom,$datepickerFrom,$datepickerTo,".submit_input_form");if($(this).val()!=""&&$datepickerTo.val()!=""){$(".submit_input_form").removeAttr("disabled");}else{$(".submit_input_form").attr("disabled","disabled");}
setTimeout(function(){add_datepicker_footer(false);},500);},onClose:function(dateText,inst){g.firstDayClassApplied=false;},});$(".datepicker-to").datepicker({minDate:0,numberOfMonths:2,yearRange:"-2:+2",showAnim:"slideDown",onChangeMonthYear:function(year,month,inst){setTimeout(function(){add_datepicker_footer(false);},150);},beforeShow:function(input,inst){$("#ui-datepicker-div").removeClass(inputIds);$("#ui-datepicker-div").addClass(this.id);setTimeout(function(){add_datepicker_footer(false);},150);return[true,""];},beforeShowDay:function(date){let validation=beforeShowDayValidation(date,'to');return[validation.validate,validation.cssClassName];},onSelect:function(dateText,inst){let $form=$(this).closest("form");let $datepickerFrom=$form.find(".datepicker-from");let $datepickerTo=$form.find(".datepicker-to");if($datepickerFrom.val()!=""&&$datepickerTo.val()!=""){$(".submit_input_form").removeAttr("disabled");}else{$(".submit_input_form").attr("disabled","disabled");}
setTimeout(function(){add_datepicker_footer(false);},500);},onClose:function(dateText,inst){g.firstDayClassApplied=false;},});});if($('.datepicker-from').val()!=''&&$('.datepicker-to').val()!=''){$('.submit_input_form').removeAttr('disabled');}else{$('.submit_input_form').attr('disabled','disabled');}
if($('#datepicker-from1').val()!=''&&$('#datepicker-to1').val()!=''){$('.submit_input_form1').removeAttr('disabled');}else{$('.submit_input_form1').attr('disabled','disabled');}
setTimeout(change_opacity,2000);});function isRestrictedNewYearDate(date){let result=false;if(date.getMonth()==11){result=date.getDate()==31;}else if(date.getMonth()==0){result=g.january_dates.indexOf(date.getDate())!=-1;}
return result;}
function onSelectEventFrom(date,$datepickerFrom,$datepickerTo,submitSelector){let disabledDates,next_index,nextDisabledDays;date.setHours(0,0,0,0);g.lastSelectedDate=new Date(date.getTime());nextDisabledDays=getNextDisabledDays(date);g.maxDate=new Date(date);g.maxDate.setDate(date.getDate()+nextDisabledDays);if(date){disabledDates=getDisabledDates(date);disabledNextIndex=disabledDates.indexOf(date)+1;$datepickerTo.datepicker("option","setDate",g.maxDate);$datepickerTo.datepicker("option","minDate",g.maxDate);if(disabledDates[disabledNextIndex]){disabledDates[disabledNextIndex].setDate(disabledDates[disabledNextIndex].getDate()+1);disabledDates[disabledNextIndex].setDate(disabledDates[disabledNextIndex].getDate()-1);$datepickerTo.datepicker("option","maxDate",disabledDates[disabledNextIndex]);}else{$datepickerTo.datepicker("option","maxDate","");}
if($datepickerFrom.val()!=""&&$datepickerTo.val()!=""){$(submitSelector).removeAttr("disabled");}else{$(submitSelector).attr("disabled","disabled");}
setTimeout(function(){$datepickerTo.datepicker("show");},500);}}
function getNextDisabledDays(date){let result=1;let holidays=apiData["search-holidays"].slice();let saturdays=apiData["search-saturdays"].slice();let fullDate=$.datepicker.formatDate("yy-mm-dd",date);let month=$.datepicker.formatDate("mm",date);let day=$.datepicker.formatDate("dd",date);let nextDate=date;let restrictedDates=[];if(holidays.indexOf(fullDate)!=-1){restrictedDates=holidays.slice(holidays.indexOf(fullDate));}
if(restrictedDates.length>0){$.each(restrictedDates,function(idx,dateString){nextDate=nextDate.addDays(1);if(dateString===$.datepicker.formatDate("yy-mm-dd",nextDate)){result++;}else{return false;}});}else if(saturdays.indexOf(fullDate)!=-1){result=1;}else if(month=="01"&&day=="03"){result=4;}else if(date.getDay()==5){result=2;}
return result;}
function formatDate(date){return jQuery.datepicker.formatDate("yy-mm-dd",date);}
function allowedSaturday(date){return apiData["search-saturdays"].indexOf(formatDate(date))!=-1;}
function restrictedRange(date){let formattedDate=formatDate(date);return apiData["search-restriction-holidays"].indexOf(formattedDate)!=-1;}
function getDisabledDates(date){let result=[];apiData["search-all"].forEach(function(item){let dateItem=new Date(item);if(!allowedSaturday(dateItem))result.push(dateItem);});result.push(date);result.sort(function(a,b){return a-b;});return result;}
function beforeShowDayValidation(date,type){var result={date:date,validate:true,reason:false,cssClassName:"",};var apiAll=apiData["search-all"].slice();var formattedDate=formatDate(date);let dateMS=+new Date(formattedDate);let maxDateMS=+new Date(apiData["search-maxdate"]);if(dateMS>maxDateMS){result.reason='over_max_date';}
if(restrictedRange(date)){result.reason="holidays_range";result.cssClassName="christmas_weekend";}else if(isRestrictedNewYearDate(date)){result.reason='new_year';}else if(!allowedSaturday(date)){if(date.getDay()==6){result.reason='saturday';}
if(type=='from'){if(apiAll.indexOf(apiData["search-maxdate"])==-1)apiAll.push(apiData["search-maxdate"]);if(apiAll.indexOf(formattedDate)!=-1){result.reason='not_work_days';}}}
result.validate=result.reason===false;if(result.validate){if(date.getDay()==5){result.cssClassName+="ui-datepicker-week-end";}
if(date.getDay()==0){result.cssClassName+=" sunday";}
if(type=='from'&&apiAll.indexOf(formattedDate)>=0||date<Date.now()){result.cssClassName+=" past_days";}
if(type=='to'){if(date<g.maxDate&&date>=g.lastSelectedDate){result.cssClassName+=" unselectedNotice";if(!g.firstDayClassApplied){g.firstDayClassApplied=true;result.cssClassName+=" selectedDay";}}}}
console.log(result);return result;}
function change_opacity(){$(".multi-booking-modal").css("position","absolute");$(".multi-booking-modal").css("left","auto");}
function add_datepicker_footer(isFrom=true){$datepickerPopup=$("#ui-datepicker-div");let availableText=isFrom?'Доступные даты заезда':'Доступные даты выезда';let headerText=isFrom?"Дата заезда":"Дата выезда";let prefix=isFrom?"datepicker-from-":"datepicker-to-";footerHTML='<div class="'+prefix+'footer">'+
'<div class="datepicker-legend">'+
(isFrom?'<div class="datepicker-legend__item check-in">Дата заезда</div>':'')+
'<div class="datepicker-legend__item inaccessible">Нет номеров в наличии</div>'+
'<div class="datepicker-legend__item available">'+availableText+'</div>'+
(isFrom?'':'<div class="datepicker-legend__item weekend">Пт-Вс, заезд минимум на 2 ночи</div>')+
'</div>'+
'<div class="datepicker-notice"><span>*</span>В выходные дни заезд возможен только на 2 ночи (Пт-Вс).</div>'+
'</div>';headerHTML='<div class="'+prefix+'header">'+headerText+'</div>';if(!$datepickerPopup.find(".datepicker-legend").length){$datepickerPopup.append(footerHTML);$datepickerPopup.prepend(headerHTML);}}
function getCalendarParameters(){if(typeof script_obj!=="undefined"){jQuery.ajax({url:script_obj.crm_api_link+"/room-types/get-calendar-parameters",success:function(json){apiData["search-holidays"]=json.data.holidays;apiData["search-saturdays"]=json.data.saturdays;apiData["search-all"]=json.data.all;apiData["search-restriction-holidays"]=json.data.restriction_holidays;apiData["search-maxdate"]=json.data.max_date;},async:false,});}else{makeApiRequest('room-types','search-all');makeApiRequest('room-types','search-saturdays');makeApiRequest('room-types','search-maxdate');makeApiRequest('room-types','search-holidays');makeApiRequest('room-types','search-restriction-holidays');}}
function makeApiRequest(service,action=''){let actionUri=action?'/'+action:'';jQuery.ajax({url:yiiOptions.homeUrl+'api/v1/'+service+actionUri,success:function(json){apiData[action]=json.data;},async:false});}